{
	debug
	local_certs
	skip_install_trust
	auto_https disable_redirects
	admin :{$GB_DD_LOCAL_ADMIN_PORT:2019}
	storage file_system {$GB_DD_CADDY_REMOTE_DIR}
}

# Configures the docker socket for local and internal access
# TODO: put more secure boundries around this - Figure out authentication
# Call this endpoint from pod:
#   * docker -H http://goblet-dind:2375 info
http://{$GB_DD_CADDY_HOST:localhost}:{$GB_DD_DOCKER_PORT:2375}, http://{$GB_DD_DEPLOYMENT:goblet-dind}:{$GB_DD_DOCKER_PORT:2375} {
	log
	reverse_proxy unix///var/run/docker.sock
}

# Grabs the last subdomain of the host, and uses it as the port in the reverse_proxy
# This allows dynamic routing to exposed ports based on the Host headers last subdomain
# Call this endpoint from pod:
#   * curl --header "Host: <port>.<user-id>.conductor.local.gobletqa.app" http://goblet-dind:2121
http://*.*.conductor.local.gobletqa.app:{$GB_DD_PROXY_PORT} {
	reverse_proxy localhost:{labels.5}

	handle_errors {
		respond "\{\"error\":\"{err.status_code} {err.status_text}\"\}"
	}
}
